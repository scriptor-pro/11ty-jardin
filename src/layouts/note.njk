{% extends "base.njk" %}

{% block content %}

<article class="note">

  {# -----------------------------------------------------------
     TITRE + STATUT
     ----------------------------------------------------------- #}
  <header class="note-header">
    {% set effectiveStatus = status %}
    {% if tags and ("cqja" in tags) %}
      {% set effectiveStatus = "cqja" %}
    {% endif %}

    <h1 class="note-title">
      {{ title }}
      {% if effectiveStatus %}
        <span class="note-status status-icon">
          {{ effectiveStatus | statusIcon }}
        </span>
      {% endif %}
    </h1>
  </header>

  {# -----------------------------------------------------------
     META DANS LE PREMIER PARAGRAPHE
     ----------------------------------------------------------- #}
  {% set notePath %}
    {% if page and page.url %}
      {{ page.url
        | replace(r/^\\//, "")
        | replace(r/\\/$/, "") }}
    {% elseif fileSlug %}
      notes/{{ fileSlug | safelink }}
    {% endif %}
  {% endset %}
  {% set notePath = notePath | trim %}

  {% set metaAside %}
    {% if id or date or updated or notePath %}
      <aside class="note-meta note-meta-aside">
        {% if notePath %}
          <span class="note-path">
            {{ notePath }}
          </span>
        {% endif %}

        {% if id %}
          <span class="note-id">
            Note #{{ id }}
          </span>
        {% endif %} 

        {% if date %}
          <span class="note-date">
            {% if id %} — {% endif %}<strong>Créée :</strong> {{ date | formatDateBE }}
          </span>
        {% endif %}

        {% if updated %}
          <span class="note-updated">
            — <strong>Modifiée :</strong> {{ updated | formatDateBE }}
          </span>
        {% endif %}
      </aside>
    {% endif %}
  {% endset %}
  {% set metaAsideContent = metaAside | trim %}

  {# -----------------------------------------------------------
     TAGS
     ----------------------------------------------------------- #}
  {% if tags %}
  <section class="note-tags">
    <h3 class="section-title">Tags</h3>
    <p>
      {% for tag in tags %}
        {% if tag != "note" %}
          <a class="note-tag" href="/tags/{{ tag | safelink }}/">{{ tag }}</a>
        {% endif %}
      {% endfor %}
    </p>
  </section>
  {% endif %}

  {# -----------------------------------------------------------
     CONTENU PRINCIPAL DE LA NOTE
     ----------------------------------------------------------- #}
  <section class="note-body">
    {% set body = content
      | stripLeadingTitle(title)
      | replace("<h1", "<h2")
      | replace("</h1>", "</h2") %}
    {% if metaAsideContent %}
      {# Inject once, right after the first opening <p ...> tag #}
      {% set body = body | replace(r/<p([^>]*?)>/, "<p\\1>" ~ metaAsideContent ~ " ") %}
    {% endif %}
    {{ body | safe }}
  </section>




  {# -----------------------------------------------------------
     BACKLINKS
     ----------------------------------------------------------- #}
  {% if backlinks and backlinks.length > 0 %}
  <section class="note-backlinks">
    <h3 class="section-title">Backlinks</h3>

    <ul>
      {% for link in backlinks %}
        <li>
          <a href="/notes/{{ link.slug }}/">
            {{ link.title }}
          </a>
        </li>
      {% endfor %}
    </ul>
  </section>
  {% endif %}

</article>

{% endblock %}
